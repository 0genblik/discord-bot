AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Discord Bot with Request Verification and Command Handling

Globals:
  Function:
    Timeout: 10
    MemorySize: 128
    Environment:
      Variables:
        POWERTOOLS_SERVICE_NAME: DiscordBot

Resources:
  VerifyRequestFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: verify_request.lambda_handler
      Runtime: python3.10
      Architectures:
        - x86_64
      Events:
        BotCalls:
          Type: Api
          Properties:
            Path: /
            Method: POST
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: 
              - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:discord_keys-*
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
              - lambda:ListFunctions
            Resource: 
              - !GetAtt HandleCommandFunction.Arn
              - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*
      Layers:
        - !Ref DependenciesLayer

  HandleCommandFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: handle_command.lambda_handler
      Runtime: python3.10
      Architectures:
        - x86_64
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: 
              - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:discord_keys-*
      Layers:
        - !Ref DependenciesLayer

  DependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: dependencies-layer
      Description: "Contains Python dependencies"
      ContentUri: package/
      CompatibleRuntimes:
        - python3.10
      RetentionPolicy: Delete

  DiscordBotAPI:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: Prod
      CorsConfiguration:
        AllowMethods:
          - POST
        AllowHeaders:
          - Content-Type
          - X-Signature-Ed25519
          - X-Signature-Timestamp
        AllowOrigins:
          - "*"
      AccessLogSettings:
        DestinationArn: !GetAtt DiscordBotAPILogGroup.Arn
        Format: '$context.requestId $context.httpMethod $context.path $context.status $context.responseLength'

  DiscordBotAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/http-api/${DiscordBotAPI}"
      RetentionInDays: 7

Outputs:
  BotApiEndpoint:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${DiscordBotAPI}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
